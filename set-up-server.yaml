---
- hosts: all
  become: true

  pre_tasks:
   - name: Update and upgrade apt packages
     apt:
      upgrade: yes
      update_cache: yes
      cache_valid_time: 86400 #One day

   - name: install cryptography python package
     ansible.builtin.package:
       name: python3-cryptography
       state: present

   - name: Create the node_exporter group
     ansible.builtin.group:
       name: "{{ node_exporter_system_group }}"
       state: present
       system: true
     when: node_exporter_system_group != "root"
     
   - name: Create the node_exporter user
     ansible.builtin.user:
       name: "{{ node_exporter_system_user }}"
       groups: "{{ node_exporter_system_group }}"
       append: true
       shell: /usr/sbin/nologin
       system: true
       create_home: false
       home: /
     when: node_exporter_system_user != "root"
     
   - name: Create node_exporter cert dir
     file:
       path: "/etc/node_exporter"
       state: directory
       owner: "{{ node_exporter_system_group }}"
       group: "{{ node_exporter_system_group }}"
       
   - name: Check /etc/node_exporter exists
     stat:
       path: "/etc/node_exporter"
     register: node_exporter_dir
     
   - name: Create private key (RSA, 4096 bits)
     community.crypto.openssl_privatekey:
       path: /etc/node_exporter/tls.key
       owner: "{{ node_exporter_system_group }}"
       group: "{{ node_exporter_system_group }}"
     when:
       - node_exporter_dir.stat.exists
       
   - name: Create cert and key
     community.crypto.x509_certificate:
       path: /etc/node_exporter/tls.cert
       privatekey_path: /etc/node_exporter/tls.key
       provider: selfsigned
       owner: "{{ node_exporter_system_group }}"
       group: "{{ node_exporter_system_group }}"
       
     when:
       - node_exporter_dir.stat.exists

  roles:
    - prometheus.prometheus.prometheus
    - prometheus.prometheus.node_exporter
  vars:
    # prometheus.prometheus.prometheus
    prometheus_targets:
      node:  # This is a base file name. File is located in "{{ prometheus_config_dir }}/file_sd/<<BASENAME>>.yml"
        - targets:              #
            - localhost:9100    # All this is a targets section in file_sd format
          labels:               #
            env: lab            #
    prometheus_scrape_configs:
      - job_name: "prometheus"    
        metrics_path: "/metrics"
        static_configs:
          - targets:
              - "localhost:9090"
      - job_name: "example-node-file-servicediscovery"
        file_sd_configs:
          - files:
              - "{{ prometheus_config_dir }}/file_sd/node.yml" # This line loads file created from prometheus_targets

    # prometheus.prometheus.node_exporter
    node_exporter_web_listen_address: localhost:9100
    node_exporter_tls_server_config:
      cert_file: /etc/node_exporter/tls.cert
      key_file: /etc/node_exporter/tls.key
    node_exporter_basic_auth_users:
      randomuser: examplepassword
      